<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sydney Informatics Hub – step2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.scss">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Sydney Informatics Hub</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../00_setup.html">
 <span class="menu-text">Setup</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-day-1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Day 1</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-day-1">    
        <li>
    <a class="dropdown-item" href="../100_regression/step1.html">
 <span class="dropdown-text">Exploratory Data Analysis (EDA) - Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../100_regression/step2.html">
 <span class="dropdown-text">Get started with tidymodels and workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-day-2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Day 2</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-day-2">    
        <li>
    <a class="dropdown-item" href="../200_classification/step1.html">
 <span class="dropdown-text">EDA - Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../200_classification/step2.html">
 <span class="dropdown-text">Tuning hyperparameters and compare multiple model workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../Tidymodels_tips_tricks.html">
 <span class="menu-text">Tips&amp;Tricks</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#machine-learning-with-tidymodels" id="toc-machine-learning-with-tidymodels" class="nav-link active" data-scroll-target="#machine-learning-with-tidymodels">Machine learning with Tidymodels</a>
  <ul class="collapse">
  <li><a href="#build-a-simple-linear-regression-model-using-base-r" id="toc-build-a-simple-linear-regression-model-using-base-r" class="nav-link" data-scroll-target="#build-a-simple-linear-regression-model-using-base-r">Build a simple linear regression model using base R</a></li>
  <li><a href="#build-a-linear-regression-model-using-tidymodels" id="toc-build-a-linear-regression-model-using-tidymodels" class="nav-link" data-scroll-target="#build-a-linear-regression-model-using-tidymodels">Build a linear regression model using Tidymodels</a>
  <ul class="collapse">
  <li><a href="#feature-engineering" id="toc-feature-engineering" class="nav-link" data-scroll-target="#feature-engineering">Feature engineering</a></li>
  <li><a href="#prep-juice-bake" id="toc-prep-juice-bake" class="nav-link" data-scroll-target="#prep-juice-bake">prep(), juice(), bake()</a></li>
  <li><a href="#build-the-model" id="toc-build-the-model" class="nav-link" data-scroll-target="#build-the-model">Build the model</a></li>
  <li><a href="#fit-the-model" id="toc-fit-the-model" class="nav-link" data-scroll-target="#fit-the-model">Fit the model</a></li>
  <li><a href="#evaluating-the-model" id="toc-evaluating-the-model" class="nav-link" data-scroll-target="#evaluating-the-model">Evaluating the model</a></li>
  <li><a href="#metrics-for-model-performance" id="toc-metrics-for-model-performance" class="nav-link" data-scroll-target="#metrics-for-model-performance">Metrics for model performance</a></li>
  <li><a href="#create-a-workflow" id="toc-create-a-workflow" class="nav-link" data-scroll-target="#create-a-workflow">Create a Workflow</a></li>
  <li><a href="#resampling" id="toc-resampling" class="nav-link" data-scroll-target="#resampling">Resampling</a></li>
  <li><a href="#back-to-the-testing-data" id="toc-back-to-the-testing-data" class="nav-link" data-scroll-target="#back-to-the-testing-data">Back to the testing data</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Sydney-Informatics-Hub/edit/main/100_regression/step2.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Sydney-Informatics-Hub/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="machine-learning-with-tidymodels" class="level1">
<h1>Machine learning with Tidymodels</h1>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Learning objective:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>From base R to tidymodels;</li>
<li>Split our data into training and test sets;</li>
<li>Preprocess the training data;</li>
<li>Specify a linear regression model;</li>
<li>Train our model on the training data;</li>
<li>Transform the test data and obtain predictions using our trained model.</li>
</ul>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercise:
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this case study, you will predict houses selling price from characteristics of these houses, like size and layout of the living space in the house. What kind of model will you build?</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>To predict a continuous, numeric quantity like selling price, use regression models.</p>
</div>
</div>
</div>
<p>Load in the packages we’ll be using for modelling:</p>
<div class="cell">

</div>
<div class="cell" data-hash="step2_cache/html/loadpackages_b69a1285e57fb1f141beb89bdcb86ae9">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rsample)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip) </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-hash="step2_cache/html/getData_85bd710bbcbd767b21560c4d20e120e6">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ames_data <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/ames_dataset_filt.qs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="build-a-simple-linear-regression-model-using-base-r" class="level2">
<h2 class="anchored" data-anchor-id="build-a-simple-linear-regression-model-using-base-r">Build a simple linear regression model using base R</h2>
<p>In a linear model, we assume that there is a linear relationship between the input variable(s) and the output variable. This means that as the input variable(s) increase or decrease, the output variable changes in a straight line.</p>
<p>Imagine you have a scatter plot with your data points all over it. A linear model is like drawing a straight line through the scatter plot that best fits all the points. The slope and intercept of this line are chosen in such a way that the distance between the line and all the points is minimized. This line is then used to predict the output for new input values.</p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="../fig/lm.png" class="img-fluid figure-img" width="500"></p>
<p></p><figcaption class="figure-caption">Example of a linear model</figcaption><p></p>
</figure>
</div>
<p>The straight red dotted line represents the linear model equation <span class="math inline">\(y=mx+c\)</span>, where <span class="math inline">\(c\)</span> is the y-intercept of the regression line, <span class="math inline">\(m\)</span> is the slope of the regression line, and <span class="math inline">\(y\)</span> is the expected value for y for the given <span class="math inline">\(x\)</span> value.</p>
<div class="cell" data-hash="step2_cache/html/lm_74703ecd6a5553082cfec142c86f8373">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#fit a linear model</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ames_lm <span class="ot">&lt;-</span> <span class="fu">lm</span>(sale_price <span class="sc">~</span> gr_liv_area, <span class="at">data =</span> ames_data)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Print the summary of the model</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ames_lm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = sale_price ~ gr_liv_area, data = ames_data)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.94258 -0.06622  0.01359  0.07298  0.39246 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 4.835e+00  7.406e-03  652.80   &lt;2e-16 ***
gr_liv_area 2.579e-04  4.714e-06   54.72   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.124 on 2923 degrees of freedom
Multiple R-squared:  0.506, Adjusted R-squared:  0.5058 
F-statistic:  2994 on 1 and 2923 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>R-squared value explains the variability of y with respect to x:</p>
<ul>
<li>varies between 0 to 1 (0-100%);</li>
<li>R-squared values closer to 0 mean the regression relationship is very low;</li>
<li>R-squared values closer to 1 mean the regression relationship is very strong.</li>
</ul>
<p>Let’s plot our linear regression model:</p>
<div class="cell" data-hash="step2_cache/html/unnamed-chunk-2_70af8b03eac790a6f1b1cfec8c7608cf">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ames_data <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>gr_liv_area,<span class="at">y=</span>sale_price)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha=</span><span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">slope =</span> <span class="fu">coef</span>(ames_lm)[[<span class="st">"gr_liv_area"</span>]],</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">intercept =</span> <span class="fu">coef</span>(ames_lm)[[<span class="st">"(Intercept)"</span>]],</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Gross Living Area"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Sale Price"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="build-a-linear-regression-model-using-tidymodels" class="level2">
<h2 class="anchored" data-anchor-id="build-a-linear-regression-model-using-tidymodels">Build a linear regression model using Tidymodels</h2>
<p>When you type <code>library(tidymodels)</code>, you load a collection of packages for modeling and machine learning using tidyverse principles. Some benefits on using Tidymodels include:</p>
<ul>
<li>consistent syntax across all of its packages, making it easier to learn and use;</li>
<li>code is more readable and easier to maintain;</li>
<li>built around the tidy data principles, which emphasizes the importance of organizing data in a consistent and structured way;</li>
<li>modular design, each package serving a specific purpose;</li>
<li>active community of developers and users who are available to answer questions and provide support;</li>
<li>integration with other tidyverse packages like dplyr, ggplot2, and purrr, allowing for a more streamlined workflow when working with data</li>
</ul>
<p>The first thing we are going to practice is splitting the data into a <strong>training set</strong> and a <strong>testing set</strong>. The tidymodels package <code>rsample</code> has functions that help you specify training and testing sets:</p>
<div class="cell" data-hash="step2_cache/html/SplitTestTrain_a1669d4c60d3d9def0379488fade3dce">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co">#so we all get the same results</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>ames_split <span class="ot">&lt;-</span> ames_data <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.8</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata =</span> sale_price) <span class="co">#stratification</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>ames_train <span class="ot">&lt;-</span> <span class="fu">training</span>(ames_split)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>ames_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(ames_split)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">qsave</span>(ames_train, <span class="st">"../_models/ames_train.qs"</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="fu">qsave</span>(ames_test, <span class="st">"../_models/ames_test.qs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Stratified sampling would split within each quartile. Splitting with stratification involves dividing the data into subsets based on the target/outcome variable’s distribution, such that the proportion of each class in the target variable is maintained in each subset. This ensures that the training and testing sets have a similar distribution of the target variable, which can lead to more reliable model performance estimates. <img src="../fig/strata.png" class="img-fluid" alt="strata"></p>
<p>The code here takes an input data set and puts 80% of it into a training dataset and 20% of it into a testing dataset; it chooses the individual cases so that both sets are balanced in selling price.</p>
<p>Let’s check if the distribution of the selling price is the same in the testing and training datasets:</p>
<div class="cell" data-hash="step2_cache/html/distr test and train_a55abd36d0de4c8ed2ac4b222f238e10">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ames_train <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(sale_price),  <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="cn">NULL</span>)) <span class="sc">+</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> ames_test,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">stat =</span> <span class="st">"density"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">"blue"</span>) <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/distr test and train-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="feature-engineering" class="level3">
<h3 class="anchored" data-anchor-id="feature-engineering">Feature engineering</h3>
<hr>
<p>We might want to modify our predictors columns for a few reasons:</p>
<ul>
<li>The model requires them in a different format;</li>
<li>The model needs certain data qualities;</li>
<li>The outcome is better predicted when one or more columns are transformed in some way (a.k.a “feature engineering”).</li>
</ul>
<p><strong>In tidymodels, you can use the <code>recipes</code> package, an extensible framework for pipeable sequences of feature engineering steps that provide preprocessing tools to be applied to data.</strong></p>
<p>Some of these steps can include:</p>
<ul>
<li>Scaling and centering numeric predictors;</li>
<li>Removing skewness from numeric variables;</li>
<li>One-hot and dummy variable encoding for categorical variables;</li>
<li>Removing correlated predictors and zero variance variables;</li>
<li>Imputing missing data.</li>
</ul>
<p><strong>Statistical parameters for the steps can be estimated from an initial data set and then applied to other data sets.</strong></p>
<p><strong>The resulting processed output can be used as inputs for statistical or machine learning models.</strong></p>
<div class="cell" data-hash="step2_cache/html/recipe_c56cab3293ada11de9d61e9cca750405">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>ames_rec <span class="ot">&lt;-</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(sale_price <span class="sc">~</span> ., <span class="at">data =</span> ames_train) <span class="sc">%&gt;%</span> <span class="co">#assigns columns to roles of “outcome” or “predictor” using the formula</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(<span class="fu">all_nominal</span>(), <span class="at">threshold =</span> <span class="fl">0.01</span>) <span class="sc">%&gt;%</span> <span class="co">#useful when you have some factor levels with very few observations,   all_nominal selects both characters and factors, pools infrequently occurring values (frequency less than 0.01) into an "other" category</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_nzv</span>(<span class="fu">all_predictors</span>()) <span class="sc">%&gt;%</span> <span class="co">#remove predictors that are highly sparse and unbalanced</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">%&gt;%</span> <span class="co">#normalize the data to a standard range by dividing each observation by the standard deviation of the feature</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="co">#create numeric representations of categorical data</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>ames_rec</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">qsave</span>(ames_rec, <span class="st">"../_models/ames_rec.qs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When calling <code>recipe(..., ames_train)</code>, the training set is used to determine the data types of each column so that selectors such as <code>all_numeric_predictors()</code> can be used.</p>
<p>Note that each successive <code>step()</code> function adds a preprocessing step to our recipe object in the order that they are provided. The preprocessing recipe <code>ames_rec</code> has been defined but no values have been estimated.</p>
</section>
<section id="prep-juice-bake" class="level3">
<h3 class="anchored" data-anchor-id="prep-juice-bake">prep(), juice(), bake()</h3>
<hr>
<div class="border">
<ul>
<li>The <code>prep()</code> function takes a recipe and computes everything so that the preprocessing steps can be executed. Note that this is done with the training data.</li>
</ul>
</div>
<div class="cell" data-hash="step2_cache/html/prep_e20e78ef0b6b57205900440562b6b972">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ames_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(ames_rec)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ames_prep</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>bake()</code> and <code>juice()</code> functions both return data, not a preprocessing recipe object.</p>
<div class="border">
<ul>
<li>The <code>bake()</code> function takes a prepped recipe (one that has had all quantities estimated from training data) and applies it to <code>new_data</code>. That new_data could be the training data again or it could be the testing data (with the TRAINING parameters).</li>
</ul>
</div>
<div class="cell" data-hash="step2_cache/html/bake_21fb2385edd3f71ced4b9efefb600119">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ames_test_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(ames_prep, <span class="at">new_data =</span> ames_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="border">
<ul>
<li>The <code>juice()</code> function is a nice little shortcut. When we <code>juice()</code> the recipe, we squeeze that training data back out, transformed in the ways we specified.</li>
</ul>
</div>
<p>Let’s compare the <code>bake()</code> and <code>juice()</code> outputs:</p>
<div class="cell" data-hash="step2_cache/html/juice_461f37377bd1ef840e5384fdd5e2565e">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ames_prep, <span class="at">new_data =</span> ames_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,339 × 224
   lot_frontage lot_area mas_vnr_area bsmt_fin_sf_1 bsmt_fin_sf_2 bsmt_unf_sf
          &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
 1       0.374   -0.212        -0.569        -1.42          0.162      -1.27 
 2       0.374    0.0383       -0.569        -1.42         -0.298      -0.288
 3      -0.137   -0.733        -0.569        -1.42         -0.298       0.341
 4      -1.01    -0.943        -0.569         1.27         -0.298       0.630
 5      -0.0770  -0.273        -0.569         1.27         -0.298       0.816
 6      -0.227   -0.359        -0.569        -1.42          0.416      -1.27 
 7       0.374   -0.0453       -0.569         1.27         -0.298       0.584
 8       0.314   -0.149        -0.569         0.372        -0.298      -1.27 
 9      -1.73    -0.0430       -0.391        -0.970        -0.298      -0.288
10      -1.73    -0.392        -0.569        -1.42         -0.298      -0.404
# ℹ 2,329 more rows
# ℹ 218 more variables: total_bsmt_sf &lt;dbl&gt;, first_flr_sf &lt;dbl&gt;,
#   second_flr_sf &lt;dbl&gt;, gr_liv_area &lt;dbl&gt;, bsmt_full_bath &lt;dbl&gt;,
#   bsmt_half_bath &lt;dbl&gt;, full_bath &lt;dbl&gt;, half_bath &lt;dbl&gt;,
#   bedroom_abv_gr &lt;dbl&gt;, tot_rms_abv_grd &lt;dbl&gt;, fireplaces &lt;dbl&gt;,
#   garage_cars &lt;dbl&gt;, garage_area &lt;dbl&gt;, wood_deck_sf &lt;dbl&gt;,
#   open_porch_sf &lt;dbl&gt;, mo_sold &lt;dbl&gt;, year_sold &lt;dbl&gt;, longitude &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">juice</span>(ames_prep) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,339 × 224
   lot_frontage lot_area mas_vnr_area bsmt_fin_sf_1 bsmt_fin_sf_2 bsmt_unf_sf
          &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
 1       0.374   -0.212        -0.569        -1.42          0.162      -1.27 
 2       0.374    0.0383       -0.569        -1.42         -0.298      -0.288
 3      -0.137   -0.733        -0.569        -1.42         -0.298       0.341
 4      -1.01    -0.943        -0.569         1.27         -0.298       0.630
 5      -0.0770  -0.273        -0.569         1.27         -0.298       0.816
 6      -0.227   -0.359        -0.569        -1.42          0.416      -1.27 
 7       0.374   -0.0453       -0.569         1.27         -0.298       0.584
 8       0.314   -0.149        -0.569         0.372        -0.298      -1.27 
 9      -1.73    -0.0430       -0.391        -0.970        -0.298      -0.288
10      -1.73    -0.392        -0.569        -1.42         -0.298      -0.404
# ℹ 2,329 more rows
# ℹ 218 more variables: total_bsmt_sf &lt;dbl&gt;, first_flr_sf &lt;dbl&gt;,
#   second_flr_sf &lt;dbl&gt;, gr_liv_area &lt;dbl&gt;, bsmt_full_bath &lt;dbl&gt;,
#   bsmt_half_bath &lt;dbl&gt;, full_bath &lt;dbl&gt;, half_bath &lt;dbl&gt;,
#   bedroom_abv_gr &lt;dbl&gt;, tot_rms_abv_grd &lt;dbl&gt;, fireplaces &lt;dbl&gt;,
#   garage_cars &lt;dbl&gt;, garage_area &lt;dbl&gt;, wood_deck_sf &lt;dbl&gt;,
#   open_porch_sf &lt;dbl&gt;, mo_sold &lt;dbl&gt;, year_sold &lt;dbl&gt;, longitude &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Note that the <code>juice()</code> output is the same as <code>bake(ames_rep, new_data = ames_train)</code> and is just a shortcut that we are going to use later.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Challenge 5
</div>
</div>
<div class="callout-body-container callout-body">
<p>Within the recipe, does it make sense to apply the preprocessing steps to the test set?</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>No, it doesn’t. You want the test set to look like new data that your model will see in the future. All preprocessing and feature engineering steps use only the training data. Otherwise, information leakage can negatively impact the model’s performance when used with new data. <img src="../fig/recipe_prep_bake.png" class="img-fluid" alt="cooking"></p>
<p>It is helpful to know how to <code>prep()</code> and <code>bake()</code> because often you want to be able to dig into the internals or troubleshoot problems with recipe preprocessing.</p>
</div>
</div>
</div>
</section>
<section id="build-the-model" class="level3">
<h3 class="anchored" data-anchor-id="build-the-model">Build the model</h3>
<p>In tidymodels, you specify models using three concepts:</p>
<ul>
<li><strong>type</strong> differentiates models such as logistic regression, linear regression, and so forth;</li>
<li><strong>mode</strong> includes common options like regression and classification, some model types support either of these while some only have one mode;</li>
<li><strong>engine</strong> is the computational tool which will be used to fit the model.</li>
</ul>
<p>We will specify the model using the <code>parsnip</code> package. Many functions have different interfaces and arguments names and parsnip standardizes the interface for fitting models as well as the return values.</p>
<div class="cell" data-hash="step2_cache/html/parnsip_c5daf5385065d6e62b73e1bc6696a42f">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#a linear regression model specification</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ames_model <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span> <span class="co">#pick a model</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)           <span class="co">#set the engine</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                             <span class="co">#set_mode("regression") we don't need this as the model linear_reg() only does regression</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#view model properties</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>ames_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
</section>
<section id="fit-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model">Fit the model</h3>
<p>Now we are ready to train our model object on the training data. We can do this using the <code>fit()</code> function from the parsnip package. The <code>fit()</code> function takes the following arguments:</p>
<ul>
<li>a parnsip model object specification;</li>
<li>a model formula</li>
<li>a data frame with the training data</li>
</ul>
<p>The code below trains our linear regression model on the prepped training data. In our formula, we have specified that sale_price is the response variable and included all the rest as our predictor variables.</p>
<div class="cell" data-hash="step2_cache/html/fit_dab1cf43f078227d0c938e395839b4f1">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>ames_fit <span class="ot">&lt;-</span> ames_model <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(sale_price <span class="sc">~</span> .,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">data=</span><span class="fu">juice</span>(ames_prep))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># View lm_fit properties</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>ames_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object


Call:
stats::lm(formula = sale_price ~ ., data = data)

Coefficients:
                                           (Intercept)  
                                             4.225e+00  
                                          lot_frontage  
                                             1.510e-03  
                                              lot_area  
                                             5.634e-03  
                                          mas_vnr_area  
                                             3.178e-03  
                                         bsmt_fin_sf_1  
                                             2.910e-02  
                                         bsmt_fin_sf_2  
                                            -2.438e-03  
                                           bsmt_unf_sf  
                                            -9.865e-03  
                                         total_bsmt_sf  
                                             3.052e-02  
                                          first_flr_sf  
                                             4.657e-03  
                                         second_flr_sf  
                                             9.635e-03  
                                           gr_liv_area  
                                             4.895e-02  
                                        bsmt_full_bath  
                                             4.946e-03  
                                        bsmt_half_bath  
                                             1.160e-03  
                                             full_bath  
                                             7.528e-03  
                                             half_bath  
                                             6.568e-03  
                                        bedroom_abv_gr  
                                            -3.780e-03  
                                       tot_rms_abv_grd  
                                            -4.477e-05  
                                            fireplaces  
                                             5.691e-03  
                                           garage_cars  
                                             8.626e-03  
                                           garage_area  
                                             6.286e-03  
                                          wood_deck_sf  
                                             1.943e-03  
                                         open_porch_sf  
                                             1.901e-03  
                                               mo_sold  
                                            -3.097e-04  
                                             year_sold  
                                            -2.016e-03  
                                             longitude  
                                            -8.325e-03  
                                              latitude  
                                            -4.980e-03  
                                    time_since_remodel  
                                            -5.556e-03  
                                             house_age  
                                            -1.929e-02  
      ms_sub_class_One_Story_1946_and_Newer_All_Styles  
                                             6.196e-03  
                 ms_sub_class_One_Story_1945_and_Older  
                                            -2.177e-02  
     ms_sub_class_One_and_Half_Story_Finished_All_Ages  
                                             2.813e-02  
                 ms_sub_class_Two_Story_1946_and_Newer  
                                            -1.093e-02  
                 ms_sub_class_Two_Story_1945_and_Older  
                                             1.847e-02  
                      ms_sub_class_Split_or_Multilevel  
                                            -2.027e-02  
                              ms_sub_class_Split_Foyer  
                                             3.816e-03  
               ms_sub_class_Duplex_All_Styles_and_Ages  
                                            -2.177e-03  
             ms_sub_class_One_Story_PUD_1946_and_Newer  
                                             2.046e-02  
             ms_sub_class_Two_Story_PUD_1946_and_Newer  
                                            -2.533e-02  
ms_sub_class_Two_Family_conversion_All_Styles_and_Ages  
                                             2.991e-03  
                                    ms_sub_class_other  
                                                    NA  
                ms_zoning_Floating_Village_Residential  
                                             3.984e-02  
                     ms_zoning_Residential_Low_Density  
                                             3.224e-02  
                  ms_zoning_Residential_Medium_Density  
                                             2.443e-02  
                                       ms_zoning_other  
                                                    NA  
                                     lot_shape_Regular  
                                             4.462e-03  
                          lot_shape_Slightly_Irregular  
                                             4.294e-03  
                        lot_shape_Moderately_Irregular  
                                             1.805e-02  
                                       lot_shape_other  
                                                    NA  
                                     lot_config_Corner  
                                             5.998e-03  
                                    lot_config_CulDSac  
                                             1.298e-02  
                                        lot_config_FR2  
                                            -5.176e-03  
                                     lot_config_Inside  
                                             3.934e-03  
                                      lot_config_other  
                                                    NA  
                               neighborhood_North_Ames  
                                            -1.547e-02  
                            neighborhood_College_Creek  
                                            -3.736e-02  
                                 neighborhood_Old_Town  
                                            -3.894e-02  
                                  neighborhood_Edwards  
                                            -4.494e-02  
                                 neighborhood_Somerset  
                                             1.495e-02  
                       neighborhood_Northridge_Heights  
                                             1.344e-02  
                                  neighborhood_Gilbert  
                                            -8.690e-03  
                                   neighborhood_Sawyer  
                                            -2.252e-02  
                           neighborhood_Northwest_Ames  
                                            -1.568e-02  
                              neighborhood_Sawyer_West  
                                            -3.405e-02  
                                 neighborhood_Mitchell  
                                            -2.449e-02  
                                neighborhood_Brookside  
                                            -1.037e-02  
                                 neighborhood_Crawford  
                                             1.911e-02  
                   neighborhood_Iowa_DOT_and_Rail_Road  
                                            -4.515e-02  
                               neighborhood_Timberland  
                                            -2.225e-02  
                               neighborhood_Northridge  
                                             1.195e-02  
                              neighborhood_Stone_Brook  
                                             3.834e-02  
  neighborhood_South_and_West_of_Iowa_State_University  
                                            -3.175e-02  
                              neighborhood_Clear_Creek  
                                            -1.395e-02  
                           neighborhood_Meadow_Village  
                                            -6.325e-02  
                                    neighborhood_other  
                                                    NA  
                                    condition_1_Artery  
                                            -1.792e-02  
                                     condition_1_Feedr  
                                            -1.227e-02  
                                      condition_1_Norm  
                                             6.575e-03  
                                      condition_1_PosN  
                                             1.180e-02  
                                      condition_1_RRAn  
                                            -1.178e-02  
                                     condition_1_other  
                                                    NA  
                                      bldg_type_OneFam  
                                             3.635e-02  
                                    bldg_type_TwoFmCon  
                                             2.470e-02  
                                      bldg_type_Duplex  
                                                    NA  
                                       bldg_type_Twnhs  
                                            -1.657e-02  
                                      bldg_type_TwnhsE  
                                                    NA  
                          house_style_One_and_Half_Fin  
                                            -3.279e-02  
                                 house_style_One_Story  
                                            -9.496e-03  
                                    house_style_SFoyer  
                                             5.423e-04  
                                      house_style_SLvl  
                                             1.420e-02  
                                 house_style_Two_Story  
                                            -8.472e-03  
                                     house_style_other  
                                                    NA  
                                     overall_qual_Fair  
                                            -9.709e-03  
                            overall_qual_Below_Average  
                                            -7.711e-03  
                                  overall_qual_Average  
                                             1.465e-02  
                            overall_qual_Above_Average  
                                             2.453e-02  
                                     overall_qual_Good  
                                             3.288e-02  
                                overall_qual_Very_Good  
                                             5.065e-02  
                                overall_qual_Excellent  
                                             5.328e-02  
                                    overall_qual_other  
                                                    NA  
                                     overall_cond_Fair  
                                             8.424e-02  
                            overall_cond_Below_Average  
                                             1.386e-01  
                                  overall_cond_Average  
                                             1.647e-01  
                            overall_cond_Above_Average  
                                             1.786e-01  
                                     overall_cond_Good  
                                             1.976e-01  
                                overall_cond_Very_Good  
                                             2.004e-01  
                                overall_cond_Excellent  
                                             2.172e-01  
                                    overall_cond_other  
                                                    NA  
                                      roof_style_Gable  
                                             3.064e-03  
                                        roof_style_Hip  
                                             1.400e-03  
                                      roof_style_other  
                                                    NA  
                                  exterior_1st_AsbShng  
                                            -2.269e-02  
                                  exterior_1st_BrkFace  
                                             1.762e-02  
                                  exterior_1st_CemntBd  
                                            -6.648e-02  
                                  exterior_1st_HdBoard  
                                            -2.029e-02  
                                  exterior_1st_MetalSd  
                                            -9.188e-03  
                                  exterior_1st_Plywood  
                                            -1.778e-02  
                                   exterior_1st_Stucco  
                                            -2.030e-02  
                                  exterior_1st_VinylSd  
                                            -3.227e-02  
                                  exterior_1st_Wd.Sdng  
                                            -1.530e-02  
                                  exterior_1st_WdShing  
                                            -2.727e-02  
                                    exterior_1st_other  
                                                    NA  
                                  exterior_2nd_AsbShng  
                                            -2.730e-02  
                                  exterior_2nd_BrkFace  
                                            -2.295e-02  
                                  exterior_2nd_CmentBd  
                                             4.882e-02  
                                  exterior_2nd_HdBoard  
                                            -5.905e-03  
                                  exterior_2nd_MetalSd  
                                            -5.823e-03  
                                  exterior_2nd_Plywood  
                                            -7.550e-03  
                                   exterior_2nd_Stucco  
                                             7.010e-03  
                                  exterior_2nd_VinylSd  
                                             9.093e-03  
                                  exterior_2nd_Wd.Sdng  
                                            -3.418e-03  
                                  exterior_2nd_Wd.Shng  
                                             3.114e-03  
                                    exterior_2nd_other  
                                                    NA  
                                  mas_vnr_type_BrkFace  
                                             1.391e-02  
                                     mas_vnr_type_None  
                                             1.470e-02  
                                    mas_vnr_type_Stone  
                                             2.233e-02  
                                    mas_vnr_type_other  
                                                    NA  
                                  exter_qual_Excellent  
                                             4.355e-02  
                                       exter_qual_Fair  
                                            -1.018e-02  
                                       exter_qual_Good  
                                             7.081e-03  
                                    exter_qual_Typical  
                                                    NA  
                                       exter_cond_Fair  
                                            -5.441e-02  
                                       exter_cond_Good  
                                            -2.790e-02  
                                    exter_cond_Typical  
                                            -2.038e-02  
                                      exter_cond_other  
                                                    NA  
                                     foundation_BrkTil  
                                            -2.178e-02  
                                     foundation_CBlock  
                                            -1.965e-02  
                                      foundation_PConc  
                                            -1.085e-02  
                                       foundation_Slab  
                                             6.116e-05  
                                      foundation_other  
                                                    NA  
                                   bsmt_qual_Excellent  
                                             3.459e-02  
                                        bsmt_qual_Fair  
                                             6.404e-03  
                                        bsmt_qual_Good  
                                             2.045e-02  
                                 bsmt_qual_No_Basement  
                                             2.428e-02  
                                     bsmt_qual_Typical  
                                             1.874e-02  
                                       bsmt_qual_other  
                                                    NA  
                                      bsmt_exposure_Av  
                                             3.624e-03  
                                      bsmt_exposure_Gd  
                                             2.669e-02  
                                      bsmt_exposure_Mn  
                                             5.688e-05  
                                      bsmt_exposure_No  
                                            -4.150e-03  
                             bsmt_exposure_No_Basement  
                                                    NA  
                                   bsmt_fin_type_1_ALQ  
                                             8.386e-02  
                                   bsmt_fin_type_1_BLQ  
                                             6.682e-02  
                                   bsmt_fin_type_1_GLQ  
                                             5.941e-02  
                                   bsmt_fin_type_1_LwQ  
                                             3.318e-02  
                           bsmt_fin_type_1_No_Basement  
                                                    NA  
                                   bsmt_fin_type_1_Rec  
                                             7.956e-03  
                                   bsmt_fin_type_1_Unf  
                                                    NA  
                                  heating_qc_Excellent  
                                             7.722e-01  
                                       heating_qc_Fair  
                                             7.472e-01  
                                       heating_qc_Good  
                                             7.654e-01  
                                    heating_qc_Typical  
                                             7.598e-01  
                                      heating_qc_other  
                                                    NA  
                                         central_air_N  
                                            -2.408e-02  
                                         central_air_Y  
                                                    NA  
                                      electrical_FuseA  
                                            -1.545e-02  
                                      electrical_FuseF  
                                            -1.968e-02  
                                      electrical_SBrkr  
                                            -1.951e-02  
                                      electrical_other  
                                                    NA  
                                kitchen_qual_Excellent  
                                             3.178e-02  
                                     kitchen_qual_Fair  
                                            -3.273e-03  
                                     kitchen_qual_Good  
                                             5.608e-03  
                                  kitchen_qual_Typical  
                                                    NA  
                                    kitchen_qual_other  
                                                    NA  
                                fireplace_qu_Excellent  
                                            -1.090e-02  
                                     fireplace_qu_Fair  
                                            -5.742e-03  
                                     fireplace_qu_Good  
                                             3.799e-03  
                             fireplace_qu_No_Fireplace  
                                            -2.870e-03  
                                     fireplace_qu_Poor  
                                            -8.559e-03  
                                  fireplace_qu_Typical  
                                                    NA  
                                    garage_type_Attchd  
                                             2.717e-02  
                                   garage_type_Basment  
                                             1.841e-02  
                                   garage_type_BuiltIn  
                                             2.514e-02  
                                    garage_type_Detchd  
                                             2.309e-02  
                                 garage_type_No_Garage  
                                             4.121e-04  
                                     garage_type_other  
                                                    NA  
                                     garage_finish_Fin  
                                             9.351e-04  
                               garage_finish_No_Garage  
                                            -5.710e-03  
                                     garage_finish_RFn  
                                            -2.171e-03  
                                     garage_finish_Unf  
                                                    NA  
                                      garage_qual_Fair  
                                            -2.731e-02  
                                 garage_qual_No_Garage  
                                                    NA  
                                   garage_qual_Typical  
                                            -1.877e-02  
                                     garage_qual_other  
                                                    NA  
                                      garage_cond_Fair  
                                            -2.552e-02  
                                 garage_cond_No_Garage  
                                                    NA  
                                   garage_cond_Typical  
                                            -1.678e-03  
                                     garage_cond_other  
                                                    NA  
                               paved_drive_Dirt_Gravel  
                                            -4.599e-03  
                          paved_drive_Partial_Pavement  
                                            -7.736e-03  
                                     paved_drive_Paved  
                                                    NA  
                                    fence_Good_Privacy  
                                            -4.646e-03  
                                       fence_Good_Wood  
                                            -1.104e-02  
                                 fence_Minimum_Privacy  
                                            -1.837e-03  
                                        fence_No_Fence  
                                            -3.494e-03  
                                           fence_other  
                                                    NA  
                                         sale_type_COD  
                                            -1.792e-02  
                                         sale_type_New  
                                             1.829e-02  
                                         sale_type_WD.  
                                            -1.673e-02  
                                       sale_type_other  
                                                    NA  
                                sale_condition_Abnorml  
                                            -4.424e-02  
                                 sale_condition_Family  
                                            -2.159e-02  
                                 sale_condition_Normal  
                                            -1.563e-03  
                                sale_condition_Partial  
                                            -2.112e-02  
                                  sale_condition_other  
                                                    NA  </code></pre>
</div>
</div>
<p>To obtain the detailed results from our trained linear regression model in a data frame, we can use the <code>tidy()</code> and <code>glance()</code> functions directly on our trained parsnip model, ames_fit.</p>
<ul>
<li>The <code>tidy()</code> function takes a linear regression object and returns a data frame of the estimated model coefficients and their associated F-statistics and p-values;</li>
<li>The <code>glance()</code> function returns performance metrics obtained on the training data;</li>
<li>We can also use the <code>vip()</code> function to plot the variable importance for each predictor in our model. The importance value is determined based on the F-statistics and estimate coefficents in our trained model object.</li>
</ul>
<div class="cell" data-hash="step2_cache/html/metrics_79940baf1433edd023985cec867af454">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data frame of estimated coefficients</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ames_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 224 × 5
   term          estimate std.error statistic   p.value
   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
 1 (Intercept)    4.22      0.0965     43.8   8.49e-300
 2 lot_frontage   0.00151   0.00121     1.24  2.14e-  1
 3 lot_area       0.00563   0.00129     4.35  1.42e-  5
 4 mas_vnr_area   0.00318   0.00168     1.89  5.90e-  2
 5 bsmt_fin_sf_1  0.0291    0.0248      1.17  2.41e-  1
 6 bsmt_fin_sf_2 -0.00244   0.00119    -2.05  4.03e-  2
 7 bsmt_unf_sf   -0.00986   0.00209    -4.71  2.61e-  6
 8 total_bsmt_sf  0.0305    0.00326     9.36  2.01e- 20
 9 first_flr_sf   0.00466   0.00910     0.512 6.09e-  1
10 second_flr_sf  0.00963   0.0100      0.960 3.37e-  1
# ℹ 214 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Performance metrics on training data</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glance</span>(ames_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 12
  r.squared adj.r.squared  sigma statistic p.value    df logLik    AIC    BIC
      &lt;dbl&gt;         &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1     0.934         0.928 0.0479      164.       0   185  3884. -7395. -6318.
# ℹ 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot variable importance</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">vip</span>(ames_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/metrics-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="evaluating-the-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluating-the-model">Evaluating the model</h3>
<p>To assess the accuracy of our trained linear regression model, we must use it to make predictions on new data. This is done with the <code>predict()</code> function from parnsip. This function takes two important arguments:</p>
<ul>
<li>a trained parnsip model object;</li>
<li>new_data for which to generate predictions.</li>
</ul>
<p>Let’s check how the model performs on our test dataset. The code below uses the <code>predict()</code> function to generate a data frame with a single column, <em>.pred</em>, which contains the predicted Sale Price values on the ames_test data.</p>
<div class="cell" data-hash="step2_cache/html/predict_0d456b1d8f9d6ef67a8a75fc04c4d331">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">predict</span>(ames_fit, <span class="at">new_data =</span> ames_test_baked)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 586 × 1
   .pred
   &lt;dbl&gt;
 1  5.03
 2  5.19
 3  5.39
 4  5.13
 5  5.23
 6  4.99
 7  4.99
 8  4.98
 9  5.14
10  5.77
# ℹ 576 more rows</code></pre>
</div>
</div>
<p>Generally it’s best to combine the new data set and the predictions into a single data frame. We create a data frame with the predictions on the training data and then use <code>bind_cols()</code> to add the baked test data to the results.</p>
<div class="cell" data-hash="step2_cache/html/merge test data and predictions_cf4739a9d90c957755d4bea0833b35b2">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ames_test_results <span class="ot">&lt;-</span> <span class="fu">predict</span>(ames_fit, <span class="at">new_data =</span> ames_test_baked) <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test_baked)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View results</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>ames_test_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 586 × 225
   .pred lot_frontage lot_area mas_vnr_area bsmt_fin_sf_1 bsmt_fin_sf_2
   &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1  5.03        0.675    0.172      -0.569          0.819         0.552
 2  5.19        0.705    0.488       0.0527        -1.42         -0.298
 3  5.39        0.916    0.145       1.45          -0.523        -0.298
 4  5.13        0.224   -0.207      -0.569         -0.970        -0.298
 5  5.23       -0.949   -0.516      -0.569         -0.523        -0.298
 6  4.99       -1.10    -1.01        2.33           0.819        -0.298
 7  4.99       -1.10    -1.01        2.26           0.819        -0.298
 8  4.98       -1.10    -1.01        1.62           1.27         -0.298
 9  5.14       -1.01    -0.943      -0.569         -1.42         -0.298
10  5.77        1.58     0.492       5.74          -0.523        -0.298
# ℹ 576 more rows
# ℹ 219 more variables: bsmt_unf_sf &lt;dbl&gt;, total_bsmt_sf &lt;dbl&gt;,
#   first_flr_sf &lt;dbl&gt;, second_flr_sf &lt;dbl&gt;, gr_liv_area &lt;dbl&gt;,
#   bsmt_full_bath &lt;dbl&gt;, bsmt_half_bath &lt;dbl&gt;, full_bath &lt;dbl&gt;,
#   half_bath &lt;dbl&gt;, bedroom_abv_gr &lt;dbl&gt;, tot_rms_abv_grd &lt;dbl&gt;,
#   fireplaces &lt;dbl&gt;, garage_cars &lt;dbl&gt;, garage_area &lt;dbl&gt;, wood_deck_sf &lt;dbl&gt;,
#   open_porch_sf &lt;dbl&gt;, mo_sold &lt;dbl&gt;, year_sold &lt;dbl&gt;, longitude &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Now we have the model results and the test data in a single data frame.</p>
</section>
<section id="metrics-for-model-performance" class="level3">
<h3 class="anchored" data-anchor-id="metrics-for-model-performance">Metrics for model performance</h3>
<div class="border">
<ul>
<li><strong>Root Mean Square Error (RMSE)</strong>: difference between the predicted and observed values (<em>loss of function</em>);</li>
<li><strong>R-squared (rsq)</strong>: squared correlation between the predicted and observed values.</li>
</ul>
</div>
<p>To obtain the rmse and rsq values on our results, we can use the <code>rmse()</code> and <code>rsq()</code> functions. Both functions take the following arguments:</p>
<ul>
<li>a data frame with columns that have the true values and predictions;</li>
<li>the column with the true response values;</li>
<li>the column with predicted values.</li>
</ul>
<p>In the examples below we pass our ames_test_results to these functions to obtain these values for our test set. Results are always returned as a data frame with the following columns: .metric, .estimator, and .estimate.</p>
<div class="cell" data-hash="step2_cache/html/rmse_572c9e358957830a196c5ff099a6a6c3">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">#RMSE on test set</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>test_rmse <span class="ot">&lt;-</span> <span class="fu">rmse</span>(ames_test_results, </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">truth =</span> sale_price,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">estimate =</span> .pred)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>test_rmse</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard      0.0656</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#rsq on test set</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>test_rsq<span class="ot">&lt;-</span> <span class="fu">rsq</span>(ames_test_results,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> sale_price,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> .pred)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>test_rsq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rsq     standard       0.858</code></pre>
</div>
</div>
<p>Let’s visualise the situation with an <strong>R2 plot</strong>:</p>
<div class="cell" data-hash="step2_cache/html/plot results_fc4a4ce4cdd8f8ed166f585e5fd100a7">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>ames_test_results <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(sale_price, .pred)) <span class="sc">+</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"black"</span>, <span class="at">linewidth =</span> <span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Selling Price"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Selling Price"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Test/Training data"</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/plot results-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This is a plot that can be used for any regression model. It plots the actual values (Sale Prices) versus the model predictions (.pred) as a scatter plot. It also plot the line y = x through the origin. This line is a visually representation of the perfect model where all predicted values are equal to the true values in the test set. The farther the points are from this line, the worse the model fit. The reason this plot is called an R2 plot, is because the R2 is the squared correlation between the true and predicted values, which are plotted as paired in the plot.</p>
</section>
<section id="create-a-workflow" class="level3">
<h3 class="anchored" data-anchor-id="create-a-workflow">Create a Workflow</h3>
<p>In the previous section, we trained a linear regression model to the housing data step-by-step. In this section, we will go over how to combine all of the modeling steps into a single workflow.</p>
<p>The <code>workflow</code> package was designed to capture the entire modeling process and combine models and recipes into a single object. To create a workflow, we start with <code>workflow()</code> to create an empty workflow and then add out model and recipe with <code>add_model()</code> and <code>add_recipe()</code>.</p>
<div class="cell" data-hash="step2_cache/html/workflow_e6e0ffefa4f7d065793b77dd7f7a6896">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>ames_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(ames_model) <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(ames_rec)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>ames_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: linear_reg()

── Preprocessor ────────────────────────────────────────────────────────────────
4 Recipe Steps

• step_other()
• step_nzv()
• step_normalize()
• step_dummy()

── Model ───────────────────────────────────────────────────────────────────────
Linear Regression Model Specification (regression)

Computational engine: lm </code></pre>
</div>
</div>
<p>We can now train our model using <code>fit()</code>. Here, the training data <code>ames_train</code> are used for all estimation operations including the recipe that is part of the workflow:</p>
<div class="cell" data-hash="step2_cache/html/unnamed-chunk-3_9261912b9c9e1b201ccb7148bfa8b059">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>ames_fit_wf <span class="ot">&lt;-</span> ames_wf <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(ames_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s check how the model performs on our test dataset with <code>predict()</code>:</p>
<div class="cell" data-hash="step2_cache/html/unnamed-chunk-4_6fb6a7d22b2e3b01d0ecf623195f03a0">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>ames_results_wf <span class="ot">&lt;-</span> <span class="fu">predict</span>(ames_fit_wf, <span class="at">new_data =</span> ames_test) <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(ames_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Note</strong> no model or preprocessor parameters like those from recipes are re-estimated using the values in <code>new_data</code>. The new values at prediction time are standardized using the values from training when <code>predict()</code> is invoked.</p>
<p>Collect RMSE and rsq metrics:</p>
<div class="cell" data-hash="step2_cache/html/wf metrics_0efd15e8b9970cfa81a208401e5667e1">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>test_rmse_wf <span class="ot">&lt;-</span> <span class="fu">rmse</span>(ames_results_wf, </span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">truth =</span> sale_price,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">estimate =</span> .pred)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>test_rmse_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard      0.0656</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>test_rsq_wf <span class="ot">&lt;-</span> <span class="fu">rsq</span>(ames_results_wf,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">truth =</span> sale_price,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate =</span> .pred)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>test_rsq_wf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rsq     standard       0.858</code></pre>
</div>
</div>
</section>
<section id="resampling" class="level3">
<h3 class="anchored" data-anchor-id="resampling">Resampling</h3>
<p>You just trained your model one time on the whole training set and then evaluated them on the testing set. Statisticians have come up with a slew of approaches to evaluate models in better ways than this; many important ones fall under the category of resampling.</p>
<p>We can resample the training set to produce an estimate of how the model will perform.You can create these resampled data sets instead of using either your training set (which can give overly optimistic results, especially for powerful ML algorithms) or your testing set (which is extremely valuable and can only be used once or at most twice). One of these resampling methods is cross-validation.</p>
<section id="cross-validation" class="level4">
<h4 class="anchored" data-anchor-id="cross-validation">Cross-validation</h4>
<p>If we only split the data once into a training and testing set, there is a risk that our model might be overfitting to the training data and perform poorly on new data. To overcome this, we can use a technique called cross-validation, which involves splitting the data into multiple subsets, or “folds”, and <strong>training and testing the model on each fold</strong>.</p>
<p>In <strong>k-fold</strong> cross-validation, we split the data into <strong>k</strong> equally sized folds. We then train the model on k-1 folds and test it on the remaining fold, repeating this process k times, so that each fold is used as the testing set once. We then average the performance of the model across all k folds to get an estimate of its generalization performance.</p>
<p>By using cross-validation, we can get a more accurate estimate of how well our model will perform on new, unseen data, and we can avoid overfitting to the training data.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Challenge 6
</div>
</div>
<div class="callout-body-container callout-body">
<p>When you implement 10-fold cross-validation repeated 5 times, you:</p>
<ul>
<li>randomly divide your training data into 50 subsets and train on 49 at a time (assessing on the other subset), iterating through all 50 subsets for assessment.</li>
<li>randomly divide your training data into 10 subsets and train on 9 at a time (assessing on the other subset), iterating through all 10 subsets for assessment. Then you repeat that process 5 times.</li>
<li>randomly divide your training data into 5 subsets and train on 4 at a time (assessing on the other subset), iterating through all 5 subsets. Then you repeat that process 10 times.</li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Simulations and practical experience show that 10-fold cross-validation repeated 5 times is a great resampling approach for many situations. This approach involves randomly dividing your training data into 10 folds, or subsets or groups, and training on only 9 while using the other fold for assessment. You iterate through all 10 folds being used for assessment; this is one round of cross-validation. You can then repeat the whole process multiple, perhaps 5, times.</p>
</div>
</div>
</div>
<div class="cell" data-hash="step2_cache/html/create cross-validation folds_41bdc9b47a5f69c857447337d5eff1a5">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>ames_folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(ames_train, <span class="at">v=</span><span class="dv">10</span>, <span class="at">repeats =</span> <span class="dv">5</span>, <span class="at">strata =</span> sale_price)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ames_folds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 3
$ splits &lt;list&gt; [&lt;vfold_split[2103 x 236 x 2339 x 81]&gt;], [&lt;vfold_split[2103 x …
$ id     &lt;chr&gt; "Repeat1", "Repeat1", "Repeat1", "Repeat1", "Repeat1", "Repeat1…
$ id2    &lt;chr&gt; "Fold01", "Fold02", "Fold03", "Fold04", "Fold05", "Fold06", "Fo…</code></pre>
</div>
</div>
<p>Once we have created a set of resamples, we can use the function <code>fit_resamples()</code> to:</p>
<ul>
<li>train and evaluate the model on each fold;</li>
<li>get the performance metrics for each fold;</li>
<li>get the average performance across all the folds.</li>
</ul>
<div class="cell" data-hash="step2_cache/html/evaluating models with resampling_b1f2eb3d3804fd2eb23f386bd0093a5e">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">234</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>ames_res <span class="ot">&lt;-</span> ames_wf <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    ames_folds,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ames_res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 50
Columns: 6
$ splits       &lt;list&gt; [&lt;vfold_split[2103 x 236 x 2339 x 81]&gt;], [&lt;vfold_split[2…
$ id           &lt;chr&gt; "Repeat1", "Repeat1", "Repeat1", "Repeat1", "Repeat1", "R…
$ id2          &lt;chr&gt; "Fold01", "Fold02", "Fold03", "Fold04", "Fold05", "Fold06…
$ .metrics     &lt;list&gt; [&lt;tbl_df[2 x 4]&gt;], [&lt;tbl_df[2 x 4]&gt;], [&lt;tbl_df[2 x 4]&gt;],…
$ .notes       &lt;list&gt; [&lt;tbl_df[1 x 3]&gt;], [&lt;tbl_df[1 x 3]&gt;], [&lt;tbl_df[1 x 3]&gt;],…
$ .predictions &lt;list&gt; [&lt;tbl_df[236 x 4]&gt;], [&lt;tbl_df[236 x 4]&gt;], [&lt;tbl_df[236 x…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">qsave</span>(ames_res, <span class="st">"../_models/ames_res.qs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p>Linear regression detects some redundancies in the predictor set. We can ignore the warnings since lm() can deal with it.</p>
</blockquote>
<p>The column .metric contains the performance statistics created from the 10 assessment sets. These can be manually unnested but the tune package contains a number of simple functions that can extract these data:</p>
<div class="cell" data-hash="step2_cache/html/resampled metrics_d72a3cda877eb7c95b92783826c8b96e">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># access the performance metrics for each fold, the average performance metric, and other information such as the predictions for each fold </span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>ames_res <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  .metric .estimator   mean     n std_err .config             
  &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   0.0540    50 0.00129 Preprocessor1_Model1
2 rsq     standard   0.909     50 0.00368 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>We can see that the regression relationship is very strong: 90.8% of the variability in the selling price can be explained by the predictors and, on average, each element in the predicted selling price differs from the actual selling price by 0.05.</p>
<p>We can reliably measure performance using only the training data.</p>
<p>If we wanted to try different model types for this data set, we could more confidently compare performance metrics computed using resampling to choose between models. Also, remember that at the end of our project, we return to our test set to estimate final model performance.</p>
<div class="cell" data-hash="step2_cache/html/plot resampling_f0c38f087735abd71ca296b44d5d8aaa">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>ames_res <span class="sc">%&gt;%</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(.pred, sale_price, <span class="at">color =</span> id)) <span class="sc">+</span> </span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.15</span>) <span class="sc">+</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Linear Regression Results - Ames Test Set'</span>,</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">'Predicted Selling Price'</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Actual Selling Price'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/plot resampling-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="back-to-the-testing-data" class="level3">
<h3 class="anchored" data-anchor-id="back-to-the-testing-data">Back to the testing data</h3>
<p>Let’s use the <code>last_fit()</code> function to evaluate once on the testing set:</p>
<div class="cell" data-hash="step2_cache/html/final fit_88570fb8ef546cdedfe107386f757071">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Final fit on test dataset</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>ames_final <span class="ot">&lt;-</span> ames_wf <span class="sc">%&gt;%</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(ames_split)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain performance metrics on test data</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">collect_metrics</span>(ames_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric .estimator .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard      0.0656 Preprocessor1_Model1
2 rsq     standard      0.858  Preprocessor1_Model1</code></pre>
</div>
</div>
<p>The R2 and RMSE metrics are similar for both the training and testing datasets in our linear regression model. This is a good sign that the model is not over-fitting and can be used for making predictions on new data.</p>
<p>We can save the test set predictions by using the <code>collect_predictions()</code> function. This function returns a data frame which will have the response variables values from the test set and a column named .pred with the model predictions.</p>
<div class="cell" data-hash="step2_cache/html/collect test predictions_7a2cb73943f48e5c5b0aed199d950bd8">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Obtain test set predictions data frame</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>ames_results_final <span class="ot">&lt;-</span> ames_final <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">collect_predictions</span>()</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View results</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>ames_results_final</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 586 × 5
   id               .pred  .row sale_price .config             
   &lt;chr&gt;            &lt;dbl&gt; &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;               
 1 train/test split  5.03     2       5.02 Preprocessor1_Model1
 2 train/test split  5.19     3       5.24 Preprocessor1_Model1
 3 train/test split  5.39    18       5.60 Preprocessor1_Model1
 4 train/test split  5.13    26       5.15 Preprocessor1_Model1
 5 train/test split  5.23    29       5.26 Preprocessor1_Model1
 6 train/test split  4.99    30       4.98 Preprocessor1_Model1
 7 train/test split  4.99    31       5.02 Preprocessor1_Model1
 8 train/test split  4.98    32       4.94 Preprocessor1_Model1
 9 train/test split  5.14    34       5.18 Preprocessor1_Model1
10 train/test split  5.77    47       5.70 Preprocessor1_Model1
# ℹ 576 more rows</code></pre>
</div>
</div>
<p>Finally, let’s use this data frame to make an R2 plot to visualize our model performance on the test data set:</p>
<div class="cell" data-hash="step2_cache/html/plot final_a463d5038b2c5c55c6894428b8a87f5f">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> ames_results_final,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>       <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> .pred, <span class="at">y =</span> sale_price)) <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">'#006EA1'</span>, <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">'black'</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">linetype=</span><span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Linear Regression Results - Ames Test Set'</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">'Predicted Selling Price'</span>,</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">'Actual Selling Price'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/plot final-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Key points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>The workflows package enables a handy type of object that can bundle pre-processing and models together;</li>
<li>You don’t have to keep track of separate objects in your workspace;</li>
<li>The recipe prepping and model fitting can be executed using a single call to <code>fit()</code> instead of <code>prep()</code>-<code>juice()</code>-<code>fit()</code>;</li>
<li>The recipe baking and model predictions are handled with a single call to <code>predict()</code> instead of <code>bake()</code>-<code>predict()</code>;</li>
<li>Workflows are be able to evaluate different recipes and models at once (as we will see in Day 2 of this workshop);</li>
<li><code>vfold_cv()</code> creates folds for cross-validation;</li>
<li><code>fit_resamples()</code> fits models to resamples;</li>
<li><code>collect_metrics()</code> obtains performance metrics from the results.</li>
</ul>
</div>
</div>
<ul>
<li><em>Adapted from “Linear Regression and tidymodels”, available <a href="https://www.gmudatamining.com/lesson-10-r-tutorial.html">here</a>.</em></li>
<li><em>Max Kuhn and Julia Silge, “Tidy Modeling with R”, Version 1.0.0(2022-12-20).</em></li>
</ul>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Copyright 2023, Sydney Informatics Hub</div>
  </div>
</footer>



</body></html>