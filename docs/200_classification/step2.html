<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sydney Informatics Hub – step2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.scss">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Sydney Informatics Hub</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html">
 <span class="menu-text">Schedule</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../00_setup.html">
 <span class="menu-text">Setup</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../Introduction.html">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-day-1" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Day 1</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-day-1">    
        <li>
    <a class="dropdown-item" href="../100_regression/step1.html">
 <span class="dropdown-text">Exploratory Data Analysis (EDA) - Regression</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../100_regression/step2.html">
 <span class="dropdown-text">Get started with tidymodels and workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-day-2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Day 2</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-day-2">    
        <li>
    <a class="dropdown-item" href="../200_classification/step1.html">
 <span class="dropdown-text">EDA - Classification</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../200_classification/step2.html">
 <span class="dropdown-text">Tuning hyperparameters and compare multiple model workflows</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../Tidymodels_tips_tricks.html">
 <span class="menu-text">Tips&amp;Tricks</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-a-classifier" id="toc-what-is-a-classifier" class="nav-link active" data-scroll-target="#what-is-a-classifier">What is a classifier?</a></li>
  <li><a href="#model-evaluation-classification" id="toc-model-evaluation-classification" class="nav-link" data-scroll-target="#model-evaluation-classification">Model evaluation (classification)</a>
  <ul class="collapse">
  <li><a href="#confusion-matrix" id="toc-confusion-matrix" class="nav-link" data-scroll-target="#confusion-matrix">Confusion Matrix</a></li>
  <li><a href="#some-common-classification-metrics" id="toc-some-common-classification-metrics" class="nav-link" data-scroll-target="#some-common-classification-metrics">Some common classification metrics</a></li>
  <li><a href="#auc-area-under-the-curve" id="toc-auc-area-under-the-curve" class="nav-link" data-scroll-target="#auc-area-under-the-curve">AUC: Area under the curve</a></li>
  </ul></li>
  <li><a href="#some-classification-models" id="toc-some-classification-models" class="nav-link" data-scroll-target="#some-classification-models">Some classification models</a>
  <ul class="collapse">
  <li><a href="#tree-based-models" id="toc-tree-based-models" class="nav-link" data-scroll-target="#tree-based-models">Tree-based models</a></li>
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression">Logistic regression</a></li>
  </ul></li>
  <li><a href="#tune-model-hyperparameters" id="toc-tune-model-hyperparameters" class="nav-link" data-scroll-target="#tune-model-hyperparameters">Tune model hyperparameters</a>
  <ul class="collapse">
  <li><a href="#find-which-parameters-will-give-the-model-its-best-accuracy" id="toc-find-which-parameters-will-give-the-model-its-best-accuracy" class="nav-link" data-scroll-target="#find-which-parameters-will-give-the-model-its-best-accuracy">Find which parameters will give the model its best accuracy</a></li>
  <li><a href="#the-workflowsets-package" id="toc-the-workflowsets-package" class="nav-link" data-scroll-target="#the-workflowsets-package">The workflowsets package</a></li>
  <li><a href="#update-and-fit-the-workflow" id="toc-update-and-fit-the-workflow" class="nav-link" data-scroll-target="#update-and-fit-the-workflow">Update and fit the workflow</a></li>
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance">Variable importance</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/Sydney-Informatics-Hub/edit/main/200_classification/step2.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/Sydney-Informatics-Hub/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Learning objective:
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Build a ML model for predicting whether a person has diabetes or not;</li>
</ul>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exercise:
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this case study, you could make predictions about whether a patient will develop diabetes or not based on their medical and demographic variables. What kind of model will you build?</p>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Unlike the first case study, when we built regression models to predict a numeric or continuous variable, in this case study we are going to build classification models, to predict the class: diabetes or no diabetes.</p>
</div>
</div>
</div>
<section id="what-is-a-classifier" class="level2">
<h2 class="anchored" data-anchor-id="what-is-a-classifier">What is a classifier?</h2>
<p>A classifier is some kind of rule / black box / widget that you can feed a new example and it will spit out whether or not it is part of a given class. E.g. below, we are classifying the animals to be either <em>cat</em> or <em>not cat</em>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../fig/CatNotCat.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">A classifier for cats and not cats.</figcaption><p></p>
</figure>
</div>
<p>You can have classifiers for anything you can have a yes/no answer to, e.g.</p>
<ul>
<li>Is this a cat? 🐱</li>
<li>Do these test results indicate cancer? 🚑</li>
<li>Is this email spam or not spam? 📧</li>
</ul>
<p>You can also have classifiers that categorise things into multiple (more than two) categories e.g.</p>
<ul>
<li>Which animal is this, out of the 12 animals I have trained my model on? 🐱</li>
<li>Do these test results indicate {none, stage 1, stage 2, stage 3, stage 4} cancer? 🚑</li>
<li>Is this email important, not important but not spam, or spam? 📧</li>
</ul>
<p>It is clear that in some of these examples we are more concerned with being wrong in one direction than the other, e.g.&nbsp;it’s better to let some spam email through accidentally than to block all of it but also junk important emails from people you know. Likewise, we would prefer our medical tests to err on the side of caution and not give a negative test result to someone who needs treatment. So we will need to adjust a parameter to decide how much we want to trade this off.</p>
</section>
<section id="model-evaluation-classification" class="level2">
<h2 class="anchored" data-anchor-id="model-evaluation-classification">Model evaluation (classification)</h2>
<p>For now, let’s imagine we have a classifier already. How can we test it to see how good it is? A good start is a confusion matrix - a table of what test data it labels correctly and incorrectly.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../fig/_CatConfusion.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Demonstration of a confusion matrix for a cat classifier that has labelled 100 animals as cats or not-cats.</figcaption><p></p>
</figure>
</div>
<section id="confusion-matrix" class="level3">
<h3 class="anchored" data-anchor-id="confusion-matrix">Confusion Matrix</h3>
<p>When applying classification models, we often use a confusion matrix to evaluate certain performance measures. A confusion matrix is a matrix that compares “the truth” to the labels generated by your classifier. When we label a cat correctly, we refer to this as a true positive. When we fail to label a cat as a cat, this is called a false negative. However, if we label something which is not a cat as a cat, this is called a false positive; and if we correctly label something which is not a cat, as not a cat, then this is a true negative. In our case, the confusion matrix will look like this:</p>
<ul>
<li><strong>true positive (TP)</strong> : Diabetic correctly identified as diabetic</li>
<li><strong>true negative (TN)</strong> : Healthy correctly identified as healthy</li>
<li><strong>false positive (FP)</strong> : Healthy incorrectly identified as diabetic</li>
<li><strong>false negative (FN)</strong> : Diabetic incorrectly identified as healthy</li>
</ul>
</section>
<section id="some-common-classification-metrics" class="level3">
<h3 class="anchored" data-anchor-id="some-common-classification-metrics">Some common classification metrics</h3>
<p>Don’t worry if you forget some of these - there are so many different words used to describe different ways to divide up the confusion matrix, it can get very confusing. I swear each time <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity#Confusion_matrix">I just look up wikipedia again</a> to figure out which part of the confusion matrix to look at. There are even more there that we won’t even bother talking about here.</p>
<section id="accuracy" class="level4 border">
<h4 class="anchored" data-anchor-id="accuracy"><strong>Accuracy</strong>:</h4>
<p>How often does the classifier label examples correctly?</p>
<p><span class="math display">\[\frac{TP+TN}{TP+TN+FP+FN} = \frac{\text{Correctly labelled examples}}{\text{All examples}}\]</span></p>
</section>
<section id="precision" class="level4 border">
<h4 class="anchored" data-anchor-id="precision"><strong>Precision</strong>:</h4>
<p>What fraction of things labelled as a cat were actually cats?</p>
<p><span class="math display">\[\frac{TP}{TP+FP} = \frac{\text{Correctly labelled cats}}{\text{All things labelled as cats}}\]</span></p>
</section>
<section id="sensitivity-recall" class="level4 border">
<h4 class="anchored" data-anchor-id="sensitivity-recall"><strong>Sensitivity / Recall</strong>:</h4>
<p>How often does the classifier label a cat as a cat?</p>
<p><span class="math display">\[\frac{TP}{TP+FN} = \frac{\text{Correctly labelled cats}}{\text{All true cats}}\]</span></p>
</section>
<section id="specificity" class="level4 border">
<h4 class="anchored" data-anchor-id="specificity"><strong>Specificity</strong>:</h4>
<p>How often does it label a not-cat as a not-cat?</p>
<p><span class="math display">\[\frac{TN}{TN+FP} = \frac{\text{Correctly labelled not-cats}}{\text{All true not-cats}}\]</span></p>
</section>
<section id="f1-score" class="level4 border">
<h4 class="anchored" data-anchor-id="f1-score"><strong>F1-score</strong>:</h4>
<p>This is a commonly used overall measure of classifier performance (but not the only one and not always the best depending upon the problem). It is defined as the harmonic mean of precision and sensitivity;</p>
<p><span class="math display">\[\frac{1}{F_1} = \frac{1}{2}\left(\frac{1}{\text{Precision}}+\frac{1}{\text{Sensitivity}}\right)\]</span></p>
</section>
</section>
<section id="auc-area-under-the-curve" class="level3">
<h3 class="anchored" data-anchor-id="auc-area-under-the-curve">AUC: Area under the curve</h3>
<p>A good classifier will have high precision and high specificity, minimizing both false positives and false negatives. In practice, and with an imperfect classifier, you can tune a knob to say which of those two you care more about. There will be some kind of a trade-off between the two.</p>
<p>To capture this balance, we often use a Reciever Operator Characteristic (ROC) curve that plots the false positive rate along the x-axis and the true positive rate along the y-axis, for all possible trade-offs. A line that is diagonal from the lower left corner to the upper right corner represents a random guess at labelling each example. The higher the line is in the upper left-hand corner, the better the classifier in general. AUC computes the area under this curve. For a perfect classifier, AUC = 1, for a random guess, AUC=0.5. Objective: maximize.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../fig/_CatArea.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">A Reciever Operator Characteristic (ROC) curve, from which the Area Under the Curve (AUC) can be calculated.</figcaption><p></p>
</figure>
</div>
<blockquote class="blockquote">
<p>For additional discussion of classification error metrics, see <a href="https://doi.org/10.1016/j.aci.2018.08.003">Tharwat 2018</a>, for example.</p>
</blockquote>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Challenge 7
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>In the case of patients with a rare disease, what can be the problem of using accuracy to evaluate the performance of a machine learning model.</li>
</ul>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Accuracy is calculated as the (TP + TN)/(total) number of cases in the dataset. If you have very few positive cases, such as when working with a rare disease, the numerator of this fraction will be dominated by the true negatives you accurately predict in your dataset - so not very informative when assessing whether your classifier predicts the disease well at all!</p>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflows)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tune)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ParallelLogger)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(workflowsets)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(qs)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>diabetes_rec <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/diabetes_rec.qs"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>diabetes_folds <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/diabetes_folds.qs"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>d_na_train <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/d_na_train.qs"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>d_na_test <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/d_na_test.qs"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>diabetes_split <span class="ot">&lt;-</span> <span class="fu">qread</span>(<span class="st">"../_models/diabetes_split.qs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">

</div>
</section>
</section>
<section id="some-classification-models" class="level2">
<h2 class="anchored" data-anchor-id="some-classification-models">Some classification models</h2>
<section id="tree-based-models" class="level3">
<h3 class="anchored" data-anchor-id="tree-based-models">Tree-based models</h3>
<p>A tree-based model is a type of algorithm that creates a tree-like structure to make predictions about a certain outcome, such as whether a customer will buy a product or not. The tree structure consists of nodes that represent different features, and the algorithm uses these features to split the data into smaller and smaller subsets. Each subset is then assigned a label based on the majority of its observations, and this process continues until the algorithm reaches a stopping criterion or has created a fully-grown tree. Once the tree is created, it can be used to make predictions by following the path through the tree that corresponds to a given set of input features. Tree-based models are simple and intuitive to understand, and can be used for both classification and regression tasks.</p>
<ul>
<li><p><strong>Decision trees</strong> are a simple type of tree-based model that use a hierarchical structure of nodes to make predictions about a certain outcome. The process continues until a stopping criterion is met, such as a maximum tree depth or a minimum number of observations per leaf node, and it can predict the outcome. A single decision tree may not be accurate enough for many real-world problems; <img src="../fig/decision_tree.png" class="img-fluid" alt="Decision_tree"></p></li>
<li><p><strong>Random forest</strong> overcomes this limitation by building many decision trees, each using a randomly selected subset of the data and features, and then combining their predictions to make a final prediction.</p></li>
</ul>
</section>
<section id="logistic-regression" class="level3">
<h3 class="anchored" data-anchor-id="logistic-regression">Logistic regression</h3>
<p>Logistic regression is a type of regression where the range of mapping is confined to [0,1], unlike simple linear regression models where the domain and range could take any real value. Logistic regression is a type of algorithm that is used to predict a binary outcome, such as whether a patient is likely to develop diabetes or no. It works by creating a mathematical function that predicts the probability of an observation belonging to a certain class (e.g., diabetes or not diabetes). The function takes into account one or more input variables, such as the patients’s age, gender, or body mass index. The output of the function is a value between 0 and 1, which represents the probability of the observation belonging to the positive class (e.g., developing diabetes). To make a prediction, the algorithm compares the predicted probability to a threshold value (e.g., 0.5), and assigns the observation to the positive class if the probability is greater than the threshold, and to the negative class otherwise. The scatter plot of this data looks something like this: <img src="../fig/lr.png" class="img-fluid" alt="Logistic Regression"> We see that the data points are in the two extreme clusters. For our prediction modeling, a naive regression line in this scenario will give a nonsense fit (red line on the right plot) and what we actually require to fit is a line (blue on the right plot) to explain (or to correctly separate) a maximum number of data points. Logistic regression is a scheme to search this most optimum blue line.</p>
<p><em>Regularization</em> is a technique that can be used to prevent overfitting of the model. A regularized logistic regression model, is a logistic classifier that has been modified to include a regularization term. This is done by adding a penalty to the model that discourages it from giving too much importance to any variable.</p>
<p>There are several regularized regression models, defined with the <code>mixture</code> parameter:</p>
<ul>
<li><strong>Ridge</strong> regularization encourages the model to have small coefficient values (<code>mixture = 0</code>);</li>
<li><strong>Lasso</strong> regularization encourages the model to set some of the coefficients to zero, which performs feature selection. This can help improve the model’s interpretability and reduce the impact of irrelevant features on the model’s performance (<code>mixture = 1</code>);</li>
<li><strong>Elastic Net</strong> regularization combines Ridge and Lasso regularization by adding a penalty term that is a weighted average of both penalties. This approach can provide the benefits of both Ridge and Lasso regularization, such as feature selection and coefficient shrinkage (<code>mixture</code> between 0 and 1).</li>
</ul>
</section>
</section>
<section id="tune-model-hyperparameters" class="level2">
<h2 class="anchored" data-anchor-id="tune-model-hyperparameters">Tune model hyperparameters</h2>
<p>Some model parameters cannot be learned directly from a dataset during model training; these kinds of parameters are called <strong>hyperparameters</strong>. Some examples of hyperparameters include the number of randomly selected variables to be considered at each split in a tree-based model (called <code>mtry</code> in tidymodels).</p>
<p>Instead of learning these kinds of hyperparameters during model training, we can estimate the best values for these parameters by training many models on a resampled data set (like the cross-validation folds we have previously created) and measuring how well all these models perform. This process is called <strong>tuning</strong>.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Challenge 8:
</div>
</div>
<div class="callout-body-container callout-body">
<p>Are these tuning hyperparameters?</p>
<ol type="1">
<li>The random seed;</li>
<li>Regularization strength in a linear regression model;</li>
<li>Threshold for minimum number of samples required to split an internal node in a decision tree.</li>
</ol>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>2 and 3 are parameters that directly affect the performance of a machine learning model during the training process.</p>
</div>
</div>
</div>
<p>You can identify which parameters to <code>tune()</code> in a model specification.</p>
<p>We can specify a random forest classifier with the following hyperparameters:</p>
<ul>
<li><strong>mtry</strong>: the number of predictors that will be randomly sampled at each split when creating the tree models;</li>
<li><strong>trees</strong>: the number of decision trees to fit and ultimately average;</li>
<li><strong>min_n</strong>: The minimum number of data points in a node that are required for the node to be split further.</li>
</ul>
<p>To specify a random forest model with tidymodels, we need the <code>rand_forest()</code> function. The hyperparameters of the model are arguments within the <code>rand_forest()</code> function and may be set to specific values. However, if tuning is required, then each of these parameters must be set to <code>tune()</code>.</p>
<p>We will be using the ranger engine. This engine has an optional importance argument which can be used to track variable importance measures. In order to make a variable importance plot with <code>vip()</code>, we must add <code>importance = 'impurity'</code> inside our <code>set_engine()</code> function:</p>
<div class="cell" data-hash="step2_cache/html/tune models_a9b50571b72abdf843e6d60817445af2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>rf_model_diabetes <span class="ot">&lt;-</span> </span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># specify that the model is a random forest and which hyperparameters need to be tuned</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="fu">tune</span>(),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">trees =</span> <span class="fu">tune</span>(),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">min_n =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select the engine/package that underlies the model</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>, <span class="at">importance =</span> <span class="st">"impurity"</span>) <span class="sc">%&gt;%</span> <span class="co">#get variable importance scores</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># choose either the continuous regression or binary classification mode</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>rlr_model_diabetes <span class="ot">&lt;-</span> </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistic_reg</span>(<span class="at">mixture =</span> <span class="fu">tune</span>(), <span class="at">penalty =</span> <span class="fu">tune</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glmnet"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<blockquote class="blockquote">
<p><strong>Note</strong> Nothing about this model specification is specific to the diabetes dataset.</p>
</blockquote>
<section id="find-which-parameters-will-give-the-model-its-best-accuracy" class="level3">
<h3 class="anchored" data-anchor-id="find-which-parameters-will-give-the-model-its-best-accuracy">Find which parameters will give the model its best accuracy</h3>
<div class="borders">
<ul>
<li>Try different values and measure their performance;</li>
<li>Find good values for these parameters;</li>
<li>Once the value(s) of the parameter(s) are determined, a model can be finalized by fitting the model to the entire training set.</li>
</ul>
</div>
<p>You have a couple of options for how to choose which possible values for the tuning parameters to try. One of these options is <strong>creating a random grid of values</strong>. Random grid search is implemented with the <code>grid_random()</code> function in tidymodels, taking a sequence of hyperparameter names to create the grid. It also has a size parameter that specifies the number of random combinations to create.</p>
<p>The <code>mtry()</code> hyperparameter requires a pre-set range of values to test since it cannot exceed the number of columns in our data. When we add this to <code>grid_random()</code> we can pass <code>mtry()</code> into the <code>range_set()</code> function and set a range for the hyperparameter with a numeric vector.</p>
<p>In the code below, we set the range from 3 to 6. This is because we have 9 columns in diabetes_data and we would like to test <code>mtry()</code> values somewhere in the middle between 1 and 9, trying to avoid values close to the ends.</p>
<p>When using <code>grid_random()</code>, it is suggested to use set.seed() for reproducibility.</p>
<p>We can then use the function <code>tune_grid()</code> to tune either a workflow or a model specification with a set of resampled data, such as the cross-validation we created. Grid search, combined with resampling, requires fitting a lot of models! These models don’t depend on one another and can be run in parallel.</p>
<div class="cell" data-hash="step2_cache/html/tune_grid_37e9bb32ed11a8e1063b44c76e036cec">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">314</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>rf_grid <span class="ot">&lt;-</span> <span class="fu">grid_random</span>(<span class="fu">mtry</span>() <span class="sc">%&gt;%</span> <span class="fu">range_set</span>(<span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">6</span>)),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">trees</span>(),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">min_n</span>(),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#View grid</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>rf_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
    mtry trees min_n
   &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1     4  1644    34
 2     6  1440    20
 3     6  1549    31
 4     5  1734    39
 5     6   332    11
 6     5  1064     3
 7     5   218    37
 8     4  1304    24
 9     4   477    32
10     5  1621     6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Tune random forest model </span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>rf_tune_model <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  rf_model_diabetes,  <span class="co">#your model</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  diabetes_rec,       <span class="co">#your recipe</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> diabetes_folds, <span class="co">#your resampling</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> rf_grid)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>rf_tune_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Tuning results
# 10-fold cross-validation repeated 5 times using stratification 
# A tibble: 50 × 5
   splits           id      id2    .metrics          .notes          
   &lt;list&gt;           &lt;chr&gt;   &lt;chr&gt;  &lt;list&gt;            &lt;list&gt;          
 1 &lt;split [483/54]&gt; Repeat1 Fold01 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 2 &lt;split [483/54]&gt; Repeat1 Fold02 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 3 &lt;split [483/54]&gt; Repeat1 Fold03 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 4 &lt;split [483/54]&gt; Repeat1 Fold04 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 5 &lt;split [483/54]&gt; Repeat1 Fold05 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 6 &lt;split [483/54]&gt; Repeat1 Fold06 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 7 &lt;split [483/54]&gt; Repeat1 Fold07 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 8 &lt;split [484/53]&gt; Repeat1 Fold08 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
 9 &lt;split [484/53]&gt; Repeat1 Fold09 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
10 &lt;split [484/53]&gt; Repeat1 Fold10 &lt;tibble [20 × 7]&gt; &lt;tibble [0 × 3]&gt;
# … with 40 more rows</code></pre>
</div>
</div>
<p>Use <code>collect_metrics</code> to extract the metrics calculated from the cross-validation performance across the different values of the parameters:</p>
<div class="cell" data-hash="step2_cache/html/collect tuning metrics_804ccc6b83022a89cd1cc082a0ac5954">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#collect metrics</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>rf_tune_model <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 40 × 9
    mtry trees min_n .metric     .estimator  mean     n std_err .config         
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;           
 1     4  1644    34 accuracy    binary     0.767    50 0.00758 Preprocessor1_M…
 2     4  1644    34 roc_auc     binary     0.848    50 0.00633 Preprocessor1_M…
 3     4  1644    34 sensitivity binary     0.863    50 0.00834 Preprocessor1_M…
 4     4  1644    34 specificity binary     0.586    50 0.0154  Preprocessor1_M…
 5     6  1440    20 accuracy    binary     0.760    50 0.00779 Preprocessor1_M…
 6     6  1440    20 roc_auc     binary     0.843    50 0.00640 Preprocessor1_M…
 7     6  1440    20 sensitivity binary     0.856    50 0.00832 Preprocessor1_M…
 8     6  1440    20 specificity binary     0.579    50 0.0156  Preprocessor1_M…
 9     6  1549    31 accuracy    binary     0.762    50 0.00772 Preprocessor1_M…
10     6  1549    31 roc_auc     binary     0.845    50 0.00643 Preprocessor1_M…
# … with 30 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#see which model performed the best, in terms of some given metric</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>rf_tune_model <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 9
   mtry trees min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1     4   477    32 roc_auc binary     0.848    50 0.00631 Preprocessor1_Model09
2     4  1644    34 roc_auc binary     0.848    50 0.00633 Preprocessor1_Model01
3     4  1304    24 roc_auc binary     0.848    50 0.00636 Preprocessor1_Model08
4     5   218    37 roc_auc binary     0.846    50 0.00640 Preprocessor1_Model07
5     5  1734    39 roc_auc binary     0.845    50 0.00640 Preprocessor1_Model04</code></pre>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Challenge 9
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use <code>tune_grid</code> and <code>collect_metrics</code> to tune a workflow. Hints:</p>
<p>Use <code>workflow()</code> to define the workflow:</p>
<div class="cell" data-hash="step2_cache/html/challenge x worflow_b51a6f59255465e21484b0d12fa8cbeb">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set the workflow</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#add the recipe</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#add the model</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Solution
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<div class="cell" data-hash="step2_cache/html/challenge x worflow solution_94de9f50763a05d2d686bec1a2123958">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set the workflow</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>rf_workflow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#add the recipe</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">add_recipe</span>(diabetes_rec) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#add the model</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_model_diabetes)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#tune the workflow</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>rf_tune_wf <span class="ot">&lt;-</span> rf_workflow <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tune_grid</span>(<span class="at">resamples =</span> diabetes_folds,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">grid =</span> rf_grid)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>rf_tune_wf <span class="sc">%&gt;%</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 20 × 9
    mtry trees min_n .metric  .estimator  mean     n std_err .config            
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;              
 1     4  1644    34 accuracy binary     0.766    50 0.00787 Preprocessor1_Mode…
 2     4  1644    34 roc_auc  binary     0.848    50 0.00628 Preprocessor1_Mode…
 3     6  1440    20 accuracy binary     0.763    50 0.00734 Preprocessor1_Mode…
 4     6  1440    20 roc_auc  binary     0.845    50 0.00642 Preprocessor1_Mode…
 5     6  1549    31 accuracy binary     0.763    50 0.00758 Preprocessor1_Mode…
 6     6  1549    31 roc_auc  binary     0.844    50 0.00646 Preprocessor1_Mode…
 7     5  1734    39 accuracy binary     0.765    50 0.00842 Preprocessor1_Mode…
 8     5  1734    39 roc_auc  binary     0.846    50 0.00635 Preprocessor1_Mode…
 9     6   332    11 accuracy binary     0.762    50 0.00736 Preprocessor1_Mode…
10     6   332    11 roc_auc  binary     0.842    50 0.00629 Preprocessor1_Mode…
11     5  1064     3 accuracy binary     0.763    50 0.00706 Preprocessor1_Mode…
12     5  1064     3 roc_auc  binary     0.844    50 0.00617 Preprocessor1_Mode…
13     5   218    37 accuracy binary     0.764    50 0.00771 Preprocessor1_Mode…
14     5   218    37 roc_auc  binary     0.845    50 0.00637 Preprocessor1_Mode…
15     4  1304    24 accuracy binary     0.763    50 0.00722 Preprocessor1_Mode…
16     4  1304    24 roc_auc  binary     0.848    50 0.00627 Preprocessor1_Mode…
17     4   477    32 accuracy binary     0.767    50 0.00800 Preprocessor1_Mode…
18     4   477    32 roc_auc  binary     0.849    50 0.00635 Preprocessor1_Mode…
19     5  1621     6 accuracy binary     0.764    50 0.00717 Preprocessor1_Mode…
20     5  1621     6 roc_auc  binary     0.843    50 0.00611 Preprocessor1_Mode…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>rf_tune_wf <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 9
   mtry trees min_n .metric .estimator  mean     n std_err .config              
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1     4   477    32 roc_auc binary     0.849    50 0.00635 Preprocessor1_Model09
2     4  1644    34 roc_auc binary     0.848    50 0.00628 Preprocessor1_Model01
3     4  1304    24 roc_auc binary     0.848    50 0.00627 Preprocessor1_Model08
4     5  1734    39 roc_auc binary     0.846    50 0.00635 Preprocessor1_Model04
5     5   218    37 roc_auc binary     0.845    50 0.00637 Preprocessor1_Model07</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Let’s visualise our results:</p>
<div class="cell" data-hash="step2_cache/html/autoplot_cb6e896c95846e9609be4cc39bb9fcb8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_tune_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/autoplot-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(rf_tune_wf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/autoplot-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can also specify the values of the parameters to tune with an tuning grid, entered as a data frame. It contains all the combinations of parameters to be tested. For regularized logistic regression, we test eleven values of mixture:</p>
<div class="cell" data-hash="step2_cache/html/tune rlr_97d3decc52f3d24d65c06c5581420133">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set the grid</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>rlr_grid <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mixture =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                       <span class="at">penalty =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.1</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>rlr_grid</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   mixture penalty
1      0.0     0.0
2      0.1     0.1
3      0.2     0.2
4      0.3     0.3
5      0.4     0.4
6      0.5     0.5
7      0.6     0.6
8      0.7     0.7
9      0.8     0.8
10     0.9     0.9
11     1.0     1.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">435</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="do">##use tune_grid() for hyperparameters tuning, doing cross validation for each row of the tuning grid</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>rlr_tune_model <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  rlr_model_diabetes,  <span class="co">#your model</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  diabetes_rec,       <span class="co">#your recipe</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> diabetes_folds, <span class="co">#your resampling</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid =</span> rlr_grid)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>rlr_tune_model <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_metrics</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 8
   penalty mixture .metric  .estimator  mean     n  std_err .config             
     &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;    &lt;dbl&gt; &lt;chr&gt;               
 1     0       0   accuracy binary     0.750    50 0.00647  Preprocessor1_Model…
 2     0       0   roc_auc  binary     0.839    50 0.00718  Preprocessor1_Model…
 3     0.1     0.1 accuracy binary     0.749    50 0.00596  Preprocessor1_Model…
 4     0.1     0.1 roc_auc  binary     0.838    50 0.00697  Preprocessor1_Model…
 5     0.2     0.2 accuracy binary     0.750    50 0.00552  Preprocessor1_Model…
 6     0.2     0.2 roc_auc  binary     0.837    50 0.00696  Preprocessor1_Model…
 7     0.3     0.3 accuracy binary     0.683    50 0.00376  Preprocessor1_Model…
 8     0.3     0.3 roc_auc  binary     0.807    50 0.00793  Preprocessor1_Model…
 9     0.4     0.4 accuracy binary     0.652    50 0.000801 Preprocessor1_Model…
10     0.4     0.4 roc_auc  binary     0.784    50 0.00843  Preprocessor1_Model…
# … with 12 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>rlr_tune_model <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_best</span>(<span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  penalty mixture .metric .estimator  mean     n std_err .config              
    &lt;dbl&gt;   &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
1     0       0   roc_auc binary     0.839    50 0.00718 Preprocessor1_Model01
2     0.1     0.1 roc_auc binary     0.838    50 0.00697 Preprocessor1_Model02
3     0.2     0.2 roc_auc binary     0.837    50 0.00696 Preprocessor1_Model03
4     0.3     0.3 roc_auc binary     0.807    50 0.00793 Preprocessor1_Model04
5     0.4     0.4 roc_auc binary     0.784    50 0.00843 Preprocessor1_Model05</code></pre>
</div>
</div>
</section>
<section id="the-workflowsets-package" class="level3">
<h3 class="anchored" data-anchor-id="the-workflowsets-package">The workflowsets package</h3>
<p>Tidymodels allows us to perform all of the above steps in a much faster way with the workflowsets package:</p>
<div class="cell" data-hash="step2_cache/html/workflow_set_bdb49536cb114b240ba8ecf0cc35eea2">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set <span class="ot">&lt;-</span> <span class="fu">workflow_set</span>(<span class="fu">list</span>(diabetes_rec),  <span class="co">#list of recipes</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>             <span class="fu">list</span>(rf_model_diabetes, rlr_model_diabetes), <span class="co">#list of models</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">cross =</span> <span class="cn">TRUE</span>) <span class="co">#all combinations of the preprocessors and models are used to create the workflows</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set<span class="sc">$</span>option</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
an empty container for options

[[2]]
an empty container for options</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set <span class="ot">&lt;-</span> diabetes_wf_set <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">option_add</span>(<span class="at">grid=</span>rf_grid, <span class="at">id=</span><span class="st">"recipe_rand_forest"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">option_add</span>(<span class="at">grid=</span>rlr_grid, <span class="at">id=</span><span class="st">"recipe_logistic_reg"</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set<span class="sc">$</span>option</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
a list of options with names:  'grid'

[[2]]
a list of options with names:  'grid'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set <span class="ot">&lt;-</span> diabetes_wf_set <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">workflow_map</span>(<span class="st">"tune_grid"</span>, <span class="co"># the first argument is a function name from the tune package (tune_grid(), fit_resamples()..)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">resamples =</span> diabetes_folds,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>) </span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>diabetes_wf_set</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A workflow set/tibble: 2 × 4
  wflow_id            info             option    result   
  &lt;chr&gt;               &lt;list&gt;           &lt;list&gt;    &lt;list&gt;   
1 recipe_rand_forest  &lt;tibble [1 × 4]&gt; &lt;opts[2]&gt; &lt;tune[+]&gt;
2 recipe_logistic_reg &lt;tibble [1 × 4]&gt; &lt;opts[2]&gt; &lt;tune[+]&gt;</code></pre>
</div>
</div>
<p>The results column contains the results of each call to <code>tune_grid()</code> for the workflows. From these results, we can get quick assessments of how well these models classified the data:</p>
<div class="cell" data-hash="step2_cache/html/wf_set results_bd7bf46d63b4025226c9b2d54d2674e1">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co">#To get the rankings of the models (and their tuning parameter sub-models) as a data frame:</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rank_results</span>(diabetes_wf_set, <span class="at">rank_metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 40 × 9
   wflow_id           .config    .metric  mean std_err     n prepr…¹ model  rank
   &lt;chr&gt;              &lt;chr&gt;      &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt; &lt;int&gt;
 1 recipe_rand_forest Preproces… accura… 0.764 0.00684    50 recipe  rand…     1
 2 recipe_rand_forest Preproces… roc_auc 0.850 0.00608    50 recipe  rand…     1
 3 recipe_rand_forest Preproces… accura… 0.768 0.00657    50 recipe  rand…     2
 4 recipe_rand_forest Preproces… roc_auc 0.850 0.00618    50 recipe  rand…     2
 5 recipe_rand_forest Preproces… accura… 0.763 0.00669    50 recipe  rand…     3
 6 recipe_rand_forest Preproces… roc_auc 0.847 0.00628    50 recipe  rand…     3
 7 recipe_rand_forest Preproces… accura… 0.766 0.00776    50 recipe  rand…     4
 8 recipe_rand_forest Preproces… roc_auc 0.846 0.00642    50 recipe  rand…     4
 9 recipe_rand_forest Preproces… accura… 0.764 0.00701    50 recipe  rand…     5
10 recipe_rand_forest Preproces… roc_auc 0.845 0.00639    50 recipe  rand…     5
# … with 30 more rows, and abbreviated variable name ¹​preprocessor</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">#plot the results</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(diabetes_wf_set, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/wf_set results-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This shows the results for all tuning parameter combinations for each model. It looks like the random forest model did well. We can use the <code>extract_workflow_set_result()</code> function to extract the tuning results:</p>
<div class="cell" data-hash="step2_cache/html/set results_309907d1654e1158214680c26e5a456b">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>best_results <span class="ot">&lt;-</span> diabetes_wf_set <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow_set_result</span>(<span class="st">"recipe_rand_forest"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select_best</span>(<span class="at">metric=</span><span class="st">"roc_auc"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>best_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
   mtry trees min_n .config              
  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;                
1     2   983    30 Preprocessor1_Model10</code></pre>
</div>
</div>
</section>
<section id="update-and-fit-the-workflow" class="level3">
<h3 class="anchored" data-anchor-id="update-and-fit-the-workflow">Update and fit the workflow</h3>
<p>The last step in hyperparameter tuning is to use <code>finalize_workflow()</code> to add our optimal model to our workflow object, and apply the <code>last_fit()</code> function to our workflow and our train/test split object. This will automatically train the model specified by the workflow using the training data, and produce evaluations based on the test set:</p>
<div class="cell" data-hash="step2_cache/html/final workflow rf_a8804b0db27bd3b938dd54cbcf889b46">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>final_diabetes_fit <span class="ot">&lt;-</span> diabetes_wf_set <span class="sc">%&gt;%</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>(<span class="st">"recipe_rand_forest"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_results) <span class="sc">%&gt;%</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">last_fit</span>(diabetes_split)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>final_diabetes_fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Resampling results
# Manual resampling 
# A tibble: 1 × 6
  splits            id               .metrics .notes   .predictions .workflow 
  &lt;list&gt;            &lt;chr&gt;            &lt;list&gt;   &lt;list&gt;   &lt;list&gt;       &lt;list&gt;    
1 &lt;split [537/231]&gt; train/test split &lt;tibble&gt; &lt;tibble&gt; &lt;tibble&gt;     &lt;workflow&gt;</code></pre>
</div>
</div>
<p>Since we supplied the train/test object when we fit the workflow, the metrics are evaluated on the test set. Now when we use the <code>collect_metrics()</code> function (the same we used when tuning our parameters) to extract the performance of the final model (since <code>rf_fit_final</code> now consists of a single final model) applied to the test set:</p>
<div class="cell" data-hash="step2_cache/html/model performance_c6f833ad60110c76cc5ce3fed7ade05d">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>test_performance <span class="ot">&lt;-</span> final_diabetes_fit <span class="sc">%&gt;%</span> <span class="fu">collect_metrics</span>()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>test_performance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  .metric  .estimator .estimate .config             
  &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;               
1 accuracy binary         0.753 Preprocessor1_Model1
2 roc_auc  binary         0.819 Preprocessor1_Model1</code></pre>
</div>
</div>
<p>We can plot the ROC curve to visualize test set performance of our random forest model, and generate a confusion matrix:</p>
<p><strong>Note</strong> In R, factor levels are ordered alphabetically by default, which means that “no” comes first before “yes” and is considered the level of interest or positive case. Use the argument <code>event_level = "second"</code> to alter this as needed.</p>
<div class="cell" data-hash="step2_cache/html/visualise performance_78f60f5dd609620595771c674e2213b0">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#ROC curve</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>(final_diabetes_fit) <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth  =</span> diabetes, <span class="at">event_level=</span><span class="st">"second"</span>, <span class="at">estimate =</span> .pred_pos) <span class="sc">%&gt;%</span>  <span class="co">#specify which level of truth to consider as the "event"</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/visualise performance-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">#confusion matrix</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>conf_matrix_rf <span class="ot">&lt;-</span> final_diabetes_fit <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect_predictions</span>() <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">conf_mat</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class) </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>conf_matrix_rf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction neg pos
       neg 128  35
       pos  22  46</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>conf_matrix_rf <span class="sc">%&gt;%</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/visualise performance-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="variable-importance" class="level3">
<h3 class="anchored" data-anchor-id="variable-importance">Variable importance</h3>
<p>In order to visualize the variable importance scores of our random forest model, we will need to manually train our workflow object with the <code>fit()</code> function on the training data, then extract the trained model with the <code>pull_workflow_fit()</code> function, and next passing the trained model to the <code>vip()</code> function:</p>
<div class="cell" data-hash="step2_cache/html/fit rf_2640a7abe30b382889b4cd92c178406d">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the final workflow</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>final_workflow <span class="ot">&lt;-</span> diabetes_wf_set <span class="sc">%&gt;%</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_workflow</span>(<span class="st">"recipe_rand_forest"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">finalize_workflow</span>(best_results)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">#fit on the training data</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>wf_fit <span class="ot">&lt;-</span> final_workflow <span class="sc">%&gt;%</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> d_na_train)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">#extract the trained model</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>wf_fit <span class="ot">&lt;-</span> wf_fit <span class="sc">%&gt;%</span> </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pull_workflow_fit</span>()</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">#plot variable importance</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="fu">vip</span>(wf_fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="step2_files/figure-html/fit rf-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This returns a ggplot object with the variable importance scores from our model.</p>
<p>We see from the results below, that the glucose concentration, body mass index and age are the most important predictors of diabetes.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Key Points
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>A workflow is a combination of a model and preprocessors (e.g, a formula, recipe, etc.);</li>
<li>In order to try different combinations of these, the <code>workflow_set()</code> function creates an object that contains many workflows;</li>
<li>The <code>workflow_map()</code> executes the function from the tune package (e.g, <code>tune_grid()</code>, <code>fit_resamples()</code>) across all the workflows in the set.</li>
</ul>
</div>
</div>
<ul>
<li><em>Adapted from “Decision Trees and Random Forests”, available <a href="https://www.gmudatamining.com/lesson-13-r-tutorial.html">here</a>.</em></li>
<li><em>Adapted from “Machine Learning with tidymodels” workshop, licensed CC Y-SA 4.0. Available <a href="https://workshops.tidymodels.org">here</a>.</em></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Copyright 2023, Sydney Informatics Hub</div>
  </div>
</footer>



</body></html>